#!/bin/bash

block_in_file() {
  local path="$1"
  local time=$(date +%s)
  local old_path="$path.old.$time"
  local new_path="$path.new.$time"
  echo "  + $path"
  add_block "$@" >$new_path
  if [ -e "$path" ]
  then
    mv $path $old_path
  fi
  mv $new_path $path
}

add_block() {
  local path="$1"
  local comment_character="$2"
  local begin_marker="$comment_character -----BEGIN MICRODOT-----"
  local end_marker="$comment_character -----END MICRODOT-----"

  if [ -e "$path" ]
  then
    local before="$(grep -B999 "^$begin_marker" $path)"
    local after="$(grep -A999 "^$end_marker" $path)"
    if [ "$before" ] && [ "$after" ]
    then
      echo "$before"
      cat
      echo "$after"
    else
      echo "$begin_marker"
      cat
      echo "$end_marker"
      echo
      cat "$path"
    fi
  else
    echo "$begin_marker"
    cat
    echo "$end_marker"
  fi
}

SRC="$(realpath $(dirname "$0"))"
cd "$SRC"
set -e


# tmux
block_in_file ~/.tmux.conf \# <<...
source $SRC/tmux.conf
...


# vim
block_in_file ~/.vimrc \" <<...
source $SRC/vimrc
...
mkdir -p ~/.vim/autoload/
cp vim/autoload/* ~/.vim/autoload
tar -C ~/.vim/ -xf vim/plugged.tar.gz


# bash
block_in_file ~/.bashrc \# <<...
source $SRC/bashrc
...


# git
mkdir -p ~/.config/git
block_in_file ~/.gitconfig \# <<...
[include]
path = $SRC/git/config

[core]
excludesfile = $SRC/git/ignore
...
